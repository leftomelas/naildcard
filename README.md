# 🎲🃏Naildcard🤖🎨

NAIでランダムプロンプトの生成を可能にするChrome拡張機能です。

## 📲インストール

> [!WARNING]
> NAIは閉じておいてください。

1. Releasesから`Naildcard.zip`をダウンロードし、解凍します。
2. Google ChromeのURL欄に`chrome://extensions/`と入力し、拡張機能の管理画面に移動します。
3. 右上隅で「デベロッパーモード」をONにします。
4. 「パッケージ化されていない拡張機能を読み込む」をクリックし、手順1.で解凍された"dist"フォルダを選択すると拡張機能がインストールされます。
    - 再インストール時は前のバージョンをアンイストールしておいてください。
5. 必要に応じて[タグデータの準備](/README.md#タグデータの準備)を実施します。

> [!CAUTION]
> アンイストールすると、保存されたワイルドカードのデータが全て削除されます。  
> バージョンアップ時など、今後も使用予定の場合は[ワイルドカードデータのエクスポート](/README.md#ワイルドカードデータのエクスポート)を実施しておいてください。

## 🚀Quick Start

1. Chromeのメニューバーの拡張機能ボタン🧩を押し、`Naildcard`を選択します。
2. 設定ページが開くので、"Enabled"をONにし、画面下部の`Dynamic Prompt`に`Hello, (world|NAI)!`を入力します。
3. NAIを開くと、生成ボタンの横に🎲ボタンが表示されます。
4. ボタンを何度か押すと、`Hello, world!`、または`Hello, NAI!`のいずれかがプロンプト欄に入力されます。何度か押してみて上記のプロンプト2種類が入力されればOKです。

-   ※手順3, 4がうまくいかない場合はNAIを再読み込みしてください。

## ⚙️設定

-   `Enabled`
    -   🎲ボタンの表示/非表示を切り替えます。
    -   設定の反映にはNAIの再読み込みが必要です。
-   `Dark Mode`
    -   ダークモード設定を切り替えます。

## 📝Dynacmic Prompt

ランダムプロンプトの入力欄です。
以下の構文を用いてランダムなプロンプトを作成します。

### 構文

#### Variants

候補の中から1つが選ばれる構文です。

##### 書き方

`(summer|autumn|winter|spring) is coming`

-   `()`内を`|`で区切って候補を指定します。
-   `summer is coming`, `spring is coming` などが生成されます。
-   各候補は2単語以上やスペース込みでもOKです。

##### 重み付け

`(5::summer|1::autumn|3::winter|spring)`

-   `n::`(n >= 0)を各候補の先頭につけることで、それが選択される確率に重み付けができます。
-   省略可能で、省略した場合は内部的に`1::`扱いとなります。
-   `0::`の場合は選択対象外となります。

##### 複数選択

`(2$$apple|banana|melon|peach|orange|grape)`

-   `()`内の先頭に`n$$`(n >= 0) をつけることで、選択される候補数を指定できます。
-   `apple, grape`, `peach, banana` などが生成されます。
-   候補は重複せず、選択の順序はランダムになります。
-   区切り文字は`, `固定です。

###### 範囲指定

`(2-4$$apple|banana|melon|peach|orange|grape)`

-   `min-max$$`で、選択される候補数の範囲を指定できます。
-   `apple, banana`, `grape, peach, banana`, `apple, melon, orange, banana`などが生成されます。
-   `min-$$`, `-max$$`のように一方の省略が可能です。
    -   `max`省略時の最大値は`候補数 - 1`です。
    -   `min`省略時の最小値は`1`です。

##### ネスト

`(1girl|(2|3|4|5|6+)girls)`

-   `( )`を重ねて使用できます。
-   `1girl`, `2girls`, `6+girls` などが生成されます。

#### ON/OFF Variants

1つの候補、または空白が選ばれる構文です。

##### 書き方

`1girl wearing shirts <and skirt>`

-   `<>`で候補を指定します。
-   ` 1girl wearing shirts and skirt`, `1girl wearing shirts `のいずれかが生成されます。
-   `1girl wearing shirts (and skirt| )`の糖衣構文です。

##### 重み付け

-   `n::`を候補の先頭につけることで、選択される確率に重み付けができます。
    -   正数: 候補が選択されやすくなります。
    -   負数: 空白が選択されやすくなります。

#### `()`, `<>`のエスケープ

-   タグに`()`, `<>`そのものが含まれる場合、`\`を`(`, `)`, `<`, `>`の前に付けてエスケープする必要があります。
-   例: `pom pom \((cheerleading|clothes)\), <\> \<>`  
    生成プロンプト: `pom pom (cheerleeding), > <`, `pom pom (clothes), ` など

#### 複合構文

各Variantsは複合できます。

##### 書き方

`(I like NAI <and SD>|She likes Bing)`

-   `I like NAI`, `I like NAI and SD`, `She likes Bing`が生成されます。

#### コメント

##### 行コメント

-   先頭に`#`をつけた行はコメント行になり、NAIのプロンプト欄には入力されません。

##### 部分コメント

-   `#...#`で囲んだ文字列はコメント行になり、NAIのプロンプト欄には入力されません。
-   行コメントが優先されます。

### その他の機能

#### プロンプトのフォーマット

-   `Format`ボタンを押すとプロンプトを整えます。以下の処理を行います。
    -   `,`のあとには半角スペースを1つだけ付ける
    -   行末に`,`を付ける
    -   括弧の前にある不要な`,`を削除する

#### エクスポート・インポート

-   `.txt`形式でプロンプトをエクスポートします。
-   `.txt`形式のファイルをインポートします。

## 🃏Wildcard Manager

ワイルドカードの編集用UIです。

### 左ペイン

-   ワイルドカードの新規登録・フィルタ・選択・名前のコピー・リネーム・削除を行います。
-   フィルタ機能ではあいまい検索によるインクリメンタルサーチでワイルドカード名を抽出できます。
-   ワイルドカード名に`()`, `<>`, `$`, `#`, `__`は使用できません。

### 右ペイン

-   左ペインで選択したワイルドカードの候補の編集を行います。
-   `Dynamic Prompt`と同じ構文が使用可能です。
-   1つの行が1候補になります。
-   ⚠️空白行は空文字の候補として扱われます。不要な改行は入れないように注意してください。

### 使用方法

候補が多いVariantsやよく使うパターンをワイルドカードとして登録し、`Dynamic Prompt`で使用します。

-   例: `person`ワイルドカードの編集

    -   左ペインでpersonを登録・選択し、右ペインに以下を記載
        ```yml
        (I|We) have
        (He|2::She) has <a>
        ```

-   例: `person`ワイルドカードの参照

    -   ワイルドカード名を`__`で囲んで`Dynamic Prompt`に記載します。

        ```yml
        __person__ car.
        ```

    -   以下のプロンプトが生成されます。
        -   `I have car.`
        -   `We have car.`
        -   `He has car.`
        -   `He has a car.`
        -   `She has car.`
        -   `She has a car.`

### 構文

#### 重み付け

-   `n::`(n >= 0)を各行の先頭につけることで、それが選択される確率に重み付けができます。
-   省略可能で、省略した場合は内部的に`1::`扱いとなります。
-   `0::`の場合は選択対象外となります。

##### 書き方

```yml
2::red
5::green
blue
0::(yellow|2::pink) and white
```

#### 複数選択

-   ワイルドカードを使用する際、`n$$`をワイルドカード名の先頭に付けることで、選択される候補の数を指定できます。
-   Variantsの複数選択と同様の範囲指定が可能です。

##### 書き方

```yml
__2$$wildcard1__
__3-5$$wildcard2__
__4-$$wildcard3__
__-6$$wildcard4__
```

#### ネスト

ワイルドカード内でワイルドカードの使用が可能です。

##### 書き方

ワイルドカード

```yml
# person
3::(I|We) have
(He|2::She) has <a>

# car
bus
bike

# clothes
shirt
hat

# person_has_something
__person__ __car__
__person__ __clothes__
```

Dynamic Prompt

```yml
__person__ (__car__|__clothes__) <and __person_has_something__>.
```

以下のようなプロンプトが生成されます。

-   `I have bus.`
-   `I have bike and She has a bus.`
-   `We have hat.`
-   `We have shirt and We have shirt.`
-   `He has shirt.`
-   `He has a hat and I have bike.`
-   `She has a bike.`

### その他の機能

#### ワイルドカードデータのエクスポート

-   登録済みの全てのワイルドカードを`.json`形式でエクスポートします。
-   拡張機能のアップデート時などに再インストールを行うとデータは削除されるため、残しておきたい場合にお使いください。

#### ワイルドカードデータのインポート

-   エクスポートしたファイルをインポートしてワイルドカードを登録します。

## 📦Danbooru Tag Helper

Danbooruタグの入力補助機能です。

### タグデータの準備

-   インストール直後はタグデータの準備が必要です。[a1111-sd-webui-tagcomplete](https://github.com/DominikDoom/a1111-sd-webui-tagcomplete/tree/main/tags)で提供されているデータを使用します。
-   リンクから`danbooru.csv`をダウンロードし、解凍した拡張機能のフォルダ配下の`dist/assets/`に置いてください。
    -   データを用意するタイミングはインストール前後どちらでも問題ありません。インストール後の場合はNaildcard画面をリロードしてください。
-   このREADME最下部のライセンスについての注意事項をご確認の上、ご使用ください。

### 使い方

1. 検索欄に文字を入力するとインクリメンタルサーチが行われ、タグ名のサジェストがポップアップします。
2. サジェストからタグ名を選択すると検索欄にタグ名が入力されます。
    - サジェストの選択は以下の操作で可能です。
        - マウスクリック
        - 上下キー + タブキー
3. この状態で`Insert`ボタン、またはEnterキーを押すと、`Dynamic Prompt`、または`Wildcard`のどちらか表示中のテキストエリアにタグを挿入します。
    - Enterキーを単体で押した場合、フォーカスはテキストエリアに移動します。Insertボタン、またはShift + Enterキーの場合は後述の設定に従います。
    - タグの挿入位置はテキストエリアのキャレット位置になります。
    - 手入力だけではボタンが活性化せず操作できません。必ず手順2.の選択操作を行ってください。
    - `()`, `<>`が含まれるタグは挿入後に自動でエスケープされます。

### 検索方法

#### Fuzzy Search (あいまい検索)

-   `Fuzzy Search`をONにするとあいまい検索が可能になります。
-   スペースの入力有無で検索方法が異なります。
    -   スペースなしの場合
        -   タグ名を部分一致で検索します。
        -   前方一致でないものもヒットします。
        -   例:
            -   入力: `rmbh`
            -   上位の結果:
                -   f`r`o`m` `b`e`h`ind
                -   xxx f`r`o`m` `b`e`h`ind
                -   `ar` ms `b`e`h`ind back
                -   `ar` ms `b`e`h`ind head
    -   スペースありの場合
        -   複数単語のタグ名を、各単語の前方一致(順不同)でAND検索します。
        -   例:
            -   入力: `lo ha`
            -   上位の結果:
                -   `lo`ng `ha`ir
                -   very `lo`ng `ha`ir
                -   short `ha`ir with `lo`ng locks

#### 通常検索

-   `Fuzzy Search`をOFFにすると前方一致で検索します。
-   複数単語の場合はスペースが必要です。

### 設定

#### Focus After Tag Insertion (タグ挿入後のフォーカス位置 )

-   Input: 検索欄
-   Prompt: 挿入したプロンプト欄

#### Search Only General Tags (Generalタグのみを検索)

ONにすると、Generalタグ以外のArtist, Copyright, Character, Metaタグを検索結果から除外します。

#### Insert Comma At (タグ挿入時のカンマ位置)

-   Auto: 周りの文字列から推論した位置(基本的にはタグの周りにカンマを付ける)
-   Before Tag: タグの前
-   After Tag: タグの後
-   Both Sides of Tag: タグの両端
-   None: 付けない

### その他の機能

#### Wiki参照

検索欄にタグ名が入力された状態で`Wiki`ボタンを押すと、そのタグのDanbooru Wikiをブラウザの新規タブで開きます。

#### タグのコピー

検索欄にタグ名が入力された状態で入力欄右のボタンを押すと、選択されたタグをクリップボードにコピーします。

#### 検索履歴

-   サジェストから選択したタグは入力履歴として保持されます。
-   検索欄に何も入力していない状態でフォーカスすると入力履歴がポップアップします。
-   入力履歴のサジェストを上下キーでハイライトした状態で`Ctrl + Deleteキー`を押すと履歴を削除できます。

### アンダースコア`_`について

検索およびタグ挿入どちらの操作でも`_`は完全に無視されます。`_`はDanbooruサイト上でのタグ名検索のみに必要な記号であり、実際のタグ名には含まれないことが理由です。

## ℹ️NAI PNG Info

NAIで生成した画像のメタデータを読み込む機能です。

### 使い方

-   アップロードエリアのクリックで画像を選択、または画像のドラッグ&ドロップで画像を読み込みます。
-   プロンプト、および生成情報を参照できます。プロンプトは`Copy`ボタンでコピーが可能です。

## ⌨ショートカットキー

`Dynacmic Prompt`, および`Wildcard Editor`内では以下のショートカットキーが使用可能です。

### `Ctrl` + `/`

-   プロンプトをコメント化します。
-   文字列の選択状態によって、操作の対象となる文字列が変わります。
    -   行内の文字列を選択中の場合
        -   選択中の文字列を部分コメント化します。部分コメントを選択中に押すと元に戻ります。
    -   複数行に渡る文字列を選択中の場合
        -   各行を行コメント化します。複数行コメントを選択中に押すと元に戻ります。
    -   未選択の場合
        -   現在行をコメント化します。もう一度押すと元に戻ります。

### `Ctrl` / `Alt` + `↑` / `↓`

-   強調括弧を増減します。
-   `Ctrl`は`{}`、`Alt`は`[]`を操作します。
-   文字列の選択状態によって、操作の対象となる文字列が変わります。
    -   選択中の場合
        -   選択中の文字列
    -   未選択の場合
        -   キャレットが括弧内にあるときは括弧内の文字列
        -   それ以外は`,`区切りの文字列

### `Ctrl` + `C`

文字列を未選択の状態で押すと、現在行をコピーします。

### `Ctrl` + `X`

文字列を未選択の状態で押すと、現在行をカットします。

### `Ctrl` + `Alt` + `↑` / `↓`

-   行を上下に移動します。
-   行の選択状態によって、操作の対象となる文字列が変わります。
    -   複数行を選択中の場合
        -   各行をまとめて移動
    -   未選択の場合
        -   現在行を移動

### `Ctrl` (+ `Shift`) + `Enter`

キャレット位置を無視して現在行の下(`Shift`は現在行)に改行を挿入します。

### `Ctrl` + `Space`

`Danbooru Tag Helper`の検索欄にフォーカスします。

### `{`, `[`, `(`, `<`キー

-   各開き括弧キーを押すと自動で括弧を閉じます。
-   文字列の選択状態によって動作が変わります。
    -   選択中の場合
        -   選択中の文字列を括弧で閉じる
    -   未選択の場合
        -   キャレットの後ろに文字がない場合のみ括弧を閉じる

## 🗑アンインストール

拡張機能の管理画面から削除します。

## タグデータの使用について

-   この拡張機能では、[a1111-sd-webui-tagcomplete](https://github.com/DominikDoom/a1111-sd-webui-tagcomplete)から提供されているCSVデータを使用します。
-   このデータはMITライセンスの下でライセンスされています。ライセンスのコピーは[こちら](https://github.com/DominikDoom/a1111-sd-webui-tagcomplete/blob/main/LICENSE)から参照可能です。CSVデータを使用する際は、このライセンスの条件を遵守してください。
